<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style type="text/css">
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
        }

        #container {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .search-bar {
            padding: 7px 10px;
            position: fixed;
            top: 10px;
            left: 20px;
            width: 300px;
            background: #fff;
            box-shadow: 0 2px 6px 0 rgba(27, 142, 236, 0.5);
            border-radius: 7px;
            z-index: 99;
        }

        .bottom-panel {
            position: fixed;
            background: #fff;
            z-index: 99;
            left: 0;
            right: 0;
            bottom: 0;
            height: 30%;
            overflow-y: auto;
            display: none;
        }

        .search-result .search-result-item {
            padding: 5px 10px;
        }

        .search-result-item:hover {
            background-color: #f3f3f3;
        }

        .title {
            font-size: 14px;
        }

        .address {
            font-size: 12px;
            color: gray;
        }

        .location {
            font-size: 12px;
            padding: 5px 10px;
            border-bottom: 1px solid #f3f3f3;
        }
    </style>
    <script type="text/javascript"
            src="//api.map.baidu.com/api?type=webgl&v=1.0&ak=7Cc5Kmn672miPzG4qQhvlOrERcXMMinq"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous"></script>
    <title>拖拽地图搜索附近地点</title>
</head>
<body>
<div id="container"></div>
<div class="bottom-panel">
    <div class="location"></div>
    <div class="search-result" id="searchResult"></div>
</div>
<script>
    var geolocation = new BMapGL.Geolocation();
    // DHL大厦: 116.525382,39.788472
    var map = new BMapGL.Map('container');
    map.centerAndZoom(new BMapGL.Point(116.525382, 39.788472), 12);
    map.enableScrollWheelZoom(true);      //开启滚轮缩放
    map.enableDragging();                 //开启惯性拖拽

    // 创建定位控件
    var locationControl = new BMapGL.LocationControl({
        // 控件的停靠位置（可选，默认左上角）
        anchor: BMAP_ANCHOR_TOP_RIGHT,
        // 控件基于停靠位置的偏移量（可选）
        offset: new BMapGL.Size(20, 20)
    });
    // 将控件添加到地图上
    map.addControl(locationControl);

    // 添加定位事件
    locationControl.addEventListener("locationSuccess", function (e) {
        var address = '';
        address += e.addressComponent.province;
        address += e.addressComponent.city;
        address += e.addressComponent.district;
        address += e.addressComponent.street;
        address += e.addressComponent.streetNumber;
        alert("当前定位地址为：" + address);
    });
    locationControl.addEventListener("locationError", function (e) {
        alert(e.message);
    });

    // local search
    var options = {
        onSearchComplete: function (results) {
            // 判断状态是否正确
            if (local.getStatus() === BMAP_STATUS_SUCCESS) {
                let searchResultDiv = $("#searchResult");
                searchResultDiv.empty();
                var addresses = [];
                for (var i = 0; i < results.getCurrentNumPois(); i++) {
                    let item = results.getPoi(i);
                    addresses.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                    let itemHtml = '<div class="search-result-item"><div class="title">' + item.title + '</div>' +
                        '<div class="address">' + item.address + '</div></div>';
                    searchResultDiv.append(itemHtml);
                }

                $('.bottom-panel').show();
                console.log(addresses);
            }
        }
    };

    var marker;
    var local = new BMapGL.LocalSearch(map, options);
    var offsetY = 0;
    geolocation.getCurrentPosition(function (r) {
        if (this.getStatus() === BMAP_STATUS_SUCCESS) {
            // var point = new BMap.Point(116.400244, 39.92556);
            map.centerAndZoom(r.point, 12); //定义地图等级，就是放大倍数
            marker = new BMapGL.Marker(r.point);// 创建标注
            map.addOverlay(marker);  // 将标注添加到地图中
            map.panTo(r.point);
            // alert('您的位置：' + r.point.lng + ',' + r.point.lat);

            //将地图中心移动到可视区中点
            //var centerPixel = map.pointToOverlayPixel(map.getCenter());
            //通过设置地图的中心点，使定位点显示在手机上部分区域
            //map.setCenter(map.overlayPixelToPoint({x: centerPixel.x, y: centerPixel.y + offsetY}));

            local.searchNearby("写字楼", new BMapGL.Point(116.525382, 39.788472), 100);
        }
    });

    map.addEventListener('dragend', function () {
        //获得移动之后地图中心点的像素位置
        var pixel = map.pointToOverlayPixel(map.getCenter());
        console.log('pixel: ', pixel);
        //获得定位图标所在位置在地图上的地理位置，实际上定位图标的像素位置就在地图中心像素位置相应的偏移量处
        var point = map.overlayPixelToPoint(new BMapGL.Pixel(pixel.x, pixel.y - offsetY));
        // var mkn = new BMap.Marker(Point);
        // map.addOverlay(mkn);
        if (marker) {
            map.removeOverlay(marker);
            marker = null;
        }
        marker = new BMapGL.Marker(new BMapGL.Point(point.lng, point.lat));
        map.addOverlay(marker);
        console.log('center: ', point);
        local.searchNearby("写字楼", point, 1000);

        $('.location').empty().append('坐标：' + point.lng + ', ' + point.lat);
    });
</script>
</body>
</html>
